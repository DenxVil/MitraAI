name: ðŸš€ Deploy Mitra AI with Diagnostics

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        required: true
        default: staging
        type: choice
        options: [staging, production]
      skip_tests:
        description: Skip tests
        required: false
        default: false
        type: boolean

concurrency:
  group: deployment-${{ github.ref }}-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_APP_NAME: mitra-ai
  AZURE_CONTAINER_ENVIRONMENT: mitra-env
  KEY_VAULT_NAME: mitra-ai-kv
  LOG_ANALYTICS_WORKSPACE: mitra-ai-logs
  APP_PORT: 8000            # â¬…ï¸ ensure this matches the port your app listens on
  CPU: 0.5
  MEMORY: 1.0Gi
  MIN_REPLICAS: 0
  MAX_REPLICAS: 3
  TRIVY_SEVERITY: "CRITICAL,HIGH"

jobs:
  preflight:
    name: ðŸ” Pre-flight
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Select environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="staging"
          fi
          [[ "$ENV" =~ ^(staging|production)$ ]] || { echo "::error::Invalid environment $ENV"; exit 1; }
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "Using environment: $ENV"

      - name: Validate required secrets
        run: |
          missing=0
          for s in AZURE_CREDENTIALS AZURE_RESOURCE_GROUP TELEGRAM_BOT_TOKEN; do
            if [ -z "${{ secrets[$s] }}" ]; then
              echo "::error::Missing secret: $s"
              missing=1
            fi
          done
          if [ $missing -eq 1 ]; then exit 1; fi

  test:
    name: ðŸ§ª Lint & Test
    runs-on: ubuntu-latest
    needs: preflight
    if: ${{ github.event.inputs.skip_tests != 'true' && github.event.inputs.skip_tests != true }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f dev-requirements.txt ]; then pip install -r dev-requirements.txt; fi
      - name: Lint (flake8 if present)
        run: |
          if command -v flake8 >/dev/null 2>&1; then flake8 || true; else echo "flake8 not installed, skipping"; fi
      - name: Run tests (pytest if present)
        run: |
          if command -v pytest >/dev/null 2>&1; then pytest || exit 1; else echo "pytest not installed, skipping"; fi

  build:
    name: ðŸ—ï¸ Build & Push Image
    runs-on: ubuntu-latest
    needs: [preflight, test]
    permissions:
      contents: read
      packages: write
      id-token: write
    outputs:
      image: ${{ steps.meta.outputs.image }}
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Set image tags
        id: meta
        run: |
          IMAGE_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          FULL="${{ env.REGISTRY }}/${IMAGE_NAME}:${SHORT_SHA}"
          STABLE="${{ env.REGISTRY }}/${IMAGE_NAME}:stable"
          echo "image=$FULL" >> $GITHUB_OUTPUT
          echo "stable=$STABLE" >> $GITHUB_OUTPUT
          echo "Image: $FULL"

      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        uses: docker/build-push-action@v5
        id: build
        with:
          context: .
          push: true
          tags: |
            ${{ steps.meta.outputs.image }}
            ${{ steps.meta.outputs.stable }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify image pull
        run: docker pull ${{ steps.meta.outputs.image }}

  deploy:
    name: ðŸš€ Deploy to Azure Container Apps
    runs-on: ubuntu-latest
    needs: [preflight, build]
    environment:
      name: ${{ needs.preflight.outputs.environment }}
    outputs:
      app_url: ${{ steps.url.outputs.app_url }}
      revision: ${{ steps.deploy.outputs.revision }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy / Update Container App
        id: deploy
        env:
          IMAGE: ${{ needs.build.outputs.image }}
          ENVIRONMENT: ${{ needs.preflight.outputs.environment }}
        run: |
          APP=${{ env.CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RESOURCE_GROUP }}
          PORT=${{ env.APP_PORT }}
          REV_SUFFIX="rev-$(date +%s)"
          echo "Using image: $IMAGE"
          if az containerapp show --name "$APP" --resource-group "$RG" >/dev/null 2>&1; then
            echo "Updating existing Container App..."
            az containerapp update \
              --name "$APP" \
              --resource-group "$RG" \
              --image "$IMAGE" \
              --revision-suffix "$REV_SUFFIX" \
              --set-env-vars \
                "ENVIRONMENT=$ENVIRONMENT" \
                "LOG_LEVEL=INFO" \
                "TELEGRAM_BOT_TOKEN=secretref:telegram-bot-token" \
              --target-port "$PORT" \
              --ingress external \
              --transport auto \
              --min-replicas ${{ env.MIN_REPLICAS }} \
              --max-replicas ${{ env.MAX_REPLICAS }} \
              --cpu ${{ env.CPU }} \
              --memory ${{ env.MEMORY }} \
              --secrets "telegram-bot-token=${{ secrets.TELEGRAM_BOT_TOKEN }}"
          else
            echo "Creating Container App..."
            az containerapp create \
              --name "$APP" \
              --resource-group "$RG" \
              --environment "${{ env.AZURE_CONTAINER_ENVIRONMENT }}" \
              --image "$IMAGE" \
              --revision-suffix "$REV_SUFFIX" \
              --registry-server "${{ env.REGISTRY }}" \
              --registry-username ${{ github.actor }} \
              --registry-password "${{ secrets.GITHUB_TOKEN }}" \
              --set-env-vars \
                "ENVIRONMENT=$ENVIRONMENT" \
                "LOG_LEVEL=INFO" \
                "TELEGRAM_BOT_TOKEN=secretref:telegram-bot-token" \
              --secrets "telegram-bot-token=${{ secrets.TELEGRAM_BOT_TOKEN }}" \
              --target-port "$PORT" \
              --ingress external \
              --transport auto \
              --min-replicas ${{ env.MIN_REPLICAS }} \
              --max-replicas ${{ env.MAX_REPLICAS }} \
              --cpu ${{ env.CPU }} \
              --memory ${{ env.MEMORY }}
          fi
          NEW_REV=$(az containerapp show --name "$APP" --resource-group "$RG" --query "properties.latestRevisionName" -o tsv)
          echo "revision=$NEW_REV" >> $GITHUB_OUTPUT
          echo "Revision: $NEW_REV"

      - name: Wait for healthy revision
        run: |
          APP=${{ env.CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RESOURCE_GROUP }}
          REV=${{ steps.deploy.outputs.revision }}
          for i in {1..60}; do
            STATE=$(az containerapp revision show --name "$APP" --resource-group "$RG" --revision "$REV" --query "properties.runningState" -o tsv 2>/dev/null || echo "Unknown")
            HEALTH=$(az containerapp revision show --name "$APP" --resource-group "$RG" --revision "$REV" --query "properties.healthState" -o tsv 2>/dev/null || echo "Unknown")
            echo "Attempt $i: state=$STATE health=$HEALTH"
            if [ "$STATE" = "Running" ] && [ "$HEALTH" = "Healthy" ]; then
              echo "Healthy!"
              break
            fi
            if [ "$STATE" = "Failed" ] || [ "$HEALTH" = "Unhealthy" ]; then
              echo "::error::Revision unhealthy (state=$STATE, health=$HEALTH)"
              exit 1
            fi
            sleep 5
          done
          if [ $i -eq 60 ]; then
            echo "::error::Timed out waiting for healthy revision"
            exit 1
          fi

      - name: Get app URL
        id: url
        run: |
          APP=${{ env.CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RESOURCE_GROUP }}
          FQDN=$(az containerapp show --name "$APP" --resource-group "$RG" --query "properties.configuration.ingress.fqdn" -o tsv 2>/dev/null || true)
          if [ -z "$FQDN" ]; then
            echo "::error::No FQDN found"
            exit 1
          fi
          echo "app_url=https://$FQDN" >> $GITHUB_OUTPUT
          echo "App URL: https://$FQDN"

      - name: HTTP health probe
        run: |
          URL="${{ steps.url.outputs.app_url }}/health"
          echo "Checking $URL"
          code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --retry 3 "$URL" || echo "000")
          if [ "$code" != "200" ]; then
            echo "::warning::Health endpoint returned $code"
          else
            echo "Health OK (200)"
          fi

      - name: ðŸ“œ Diagnostics on failure or demand
        if: failure() || github.event.inputs.environment == 'staging'
        run: |
          APP=${{ env.CONTAINER_APP_NAME }}
          RG=${{ secrets.AZURE_RESOURCE_GROUP }}
          REV=${{ steps.deploy.outputs.revision }}
          echo "=== Revision describe ==="
          az containerapp revision show --name "$APP" --resource-group "$RG" --revision "$REV" -o yaml || true
          echo "=== Recent revisions ==="
          az containerapp revision list --name "$APP" --resource-group "$RG" --query "[].{name:name,health:properties.healthState,state:properties.runningState,created:properties.createdTime}" -o table || true
          echo "=== Replica list ==="
          az containerapp replica list --name "$APP" --resource-group "$RG" --revision "$REV" -o table || true
          REPLICA=$(az containerapp replica list --name "$APP" --resource-group "$RG" --revision "$REV" --query "[0].name" -o tsv 2>/dev/null || true)
          if [ -n "$REPLICA" ]; then
            echo "=== Replica describe ($REPLICA) ==="
            az containerapp replica show --name "$APP" --resource-group "$RG" --revision "$REV" --replica "$REPLICA" -o yaml || true
            echo "=== Replica logs (latest 200 lines) ==="
            az containerapp logs show --name "$APP" --resource-group "$RG" --revision "$REV" --replica "$REPLICA" --tail 200 || true
          fi
          echo "=== App logs (tail 200) ==="
          az containerapp logs show --name "$APP" --resource-group "$RG" --tail 200 || true
